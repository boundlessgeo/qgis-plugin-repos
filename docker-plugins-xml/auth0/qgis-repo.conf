
include       uwsgi_params;

# 'release' plugin repository
server {
  listen 80 default;
  listen 443 ssl;

  server_name domain-tld;

  access_log /var/log/nginx/domain-tld-access.log;
  error_log /var/log/nginx/domain-tld-error.log error;

  include incl.d/ssl_cert;

  root /var/www/qgis;

  # Also allows POST for access_token
  include incl.d/request_methods_get-head-post;

  include incl.d/indexes;
  autoindex on;

  include incl.d/redirect_from_django_app;

  # Packages in this section require authentication
  # A Flask app handles Auth0 authentication
  location /plugins/packages-auth {
    include incl.d/redirect_to_https;
    include uwsgi_params;
    uwsgi_pass unix:///tmp/uwsgi.sock;
  }

  # XML listing and filtering
  # Flask app
  location ~* /(plugins/)?plugins.xml$ {
    include uwsgi_params;
    uwsgi_pass unix:///tmp/uwsgi.sock;
  }

  location / {
    include incl.d/try_file-dir-index;
  }

  include incl.d/missing;
  include incl.d/deny_.files;
}

# 'dev' plugin repository
server {
  listen 80;
  listen 443 ssl;

  server_name domain-tld-dev;

  access_log /var/log/nginx/domain-tld-dev-access.log;
  error_log /var/log/nginx/domain-tld-dev-error.log error;

  include incl.d/ssl_cert;

  root /var/www/qgis-dev;

  # Also allows POST for access_token
  include incl.d/request_methods_get-head-post;

  include incl.d/indexes;
  autoindex on;

  # Packages in this section require authentication
  # A Flask app handles Auth0 authentication
  location /plugins/packages-auth {
    include incl.d/redirect_to_https;
    include uwsgi_params;
    uwsgi_pass unix:///tmp/uwsgi.sock;
  }

  # XML listing and filtering
  # Flask app
  location ~* /(plugins/)?plugins.xml$ {
    include uwsgi_params;
    uwsgi_pass unix:///tmp/uwsgi.sock;
  }

  location / {
    include incl.d/try_file-dir-index;
  }

  include incl.d/missing;
  include incl.d/deny_.files;
}
